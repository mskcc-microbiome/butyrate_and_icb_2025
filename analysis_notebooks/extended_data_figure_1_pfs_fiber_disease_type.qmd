--- 
title: |
  Extended Figure 1: PFS vs Fiber by Disease Type
---



```{r}
#| echo: false
#| warning: false
#| include: false
#| label: library_data_imports

library(dplyr)
library(survival)
library(survminer)
library(forestplot)
source("utility_funcs.R")
```

The data we are visualizing here has the following structure:


```{r}
#| warning: false
#| include: false
#| label: load_data


all_metadata_fiber <- readRDS("../public_data/fiber_data/all_metadata_fiber.RDS")
data <- readRDS("../public_data/fiber_data/fiber_data_clean_labels.RDS")

# Pull out different sub-groups from this data:

UCdata=filter(data,cancer_type!=4)
UCdata$TMBhigherThan10<-ifelse(UCdata$Impact.TMB.Score>=10,1,0)
UCdata<-mutate(UCdata,TMBhigherThan10.Imputed = case_when(is.na(TMBhigherThan10)==FALSE~TMBhigherThan10,
                                                          is.na(TMBhigherThan10)==TRUE~0))
mUCdata=filter(UCdata,io_regimen!=6 & io_regimen!=13 & io_regimen!=15)
mUCdataFiber=filter(mUCdata,((calor>=600 & calor<=4200 & sex.factor=="Male") 
                    |(calor>=500 & calor<=3500 & sex.factor=="Female"))&(nblank<=70))


RCdata=filter(data,cancer_type==4)
mRCdata=filter(RCdata,io_regimen!=7 & io_regimen!=15 & io_regimen!=99)
mRCdataFiber=filter(mRCdata,((calor>=600 & calor<=4200 & sex.factor=="Male") 
                             |(calor>=500 & calor<=3500 & sex.factor=="Female"))&(nblank<=70))

AllMetdata=filter(data,io_regimen!=6 & io_regimen!=13 & io_regimen!=7 & io_regimen!=15)


AllMetdataFiber=filter(AllMetdata,((calor>=600 & calor<=4200 & sex.factor=="Male") 
                                   |(calor>=500 & calor<=3500 & sex.factor=="Female"))&(nblank<=70))
AllMetdataFiber <- mutate(AllMetdataFiber, WhiteRace = if_else(race.factor=="White",1,0))
AllMetdataFiber <- mutate(AllMetdataFiber, kcalor = calor/1000)

AllMetdataFiber <- mutate(AllMetdataFiber, gram_fiber_per_Kcal = aofib/kcalor)

AllMetdataFiber <- mutate(AllMetdataFiber,  gram_fiber_per_Kcal_aboveRecommended = case_when(gram_fiber_per_Kcal>=15~1,
                                                                                             gram_fiber_per_Kcal<15~0))

```

## Panel A

Mortality Hazard for PFS by daily average fiber intake, visualized via partial smoothing spline for pateints with Renal Cell Cancer.  Ticks along the x axis represent individual patients. 

```{r}
#| warning: false
#| include: true
#| label: panel_a_prep

cox_pfs_allMet_mv <-coxph(Surv(pfs_mo,
                               pod_status)~ fiber_dichotomized + 
                            ageby10 + 
                            ecog_1to5_final +
                            cancer_RCCvsUC_NAME,
                          all_metadata_fiber)

summary(cox_pfs_allMet_mv)


cox_pfs_allMet_mv2 <-coxph(Surv(pfs_mo,
                                pod_status)~ fiber_dichotomized + 
                             calor +
                             ageby10 + 
                             ecog_1to5_final +
                             cancer_RCCvsUC_NAME,
                           all_metadata_fiber)

summary(cox_pfs_allMet_mv2)


cox_pfs_allMet_mv3 <-coxph(Surv(pfs_mo,
                                pod_status)~ fiber_dichotomized + 
                             Impact.TMB.Imputed +
                             ageby10 + 
                             ecog_1to5_final +
                             cancer_RCCvsUC_NAME,
                           all_metadata_fiber)

summary(cox_pfs_allMet_mv3)
```
```{r}
#| warning: false
#| include: true
#| label: panel_a

kmPFS<-survfit(Surv(pfs_mo, pod_status)~fiber_dichotomized,
               type="kaplan-meier", data=mRCdataFiber)

pfs_rcc <- ggsurvplot(kmPFS,risk.table=TRUE,
           xlab="Time (months)", 
           ylab="Progression-free survival",
           pval = TRUE,
           legend="none",
           title="Patients with renal cell cancer on ICB",
           legend.title="Fiber intake",
           legend.labs=c("<15 g/day","15+ g/day"),
           #surv.median.line = "hv",
           conf.int=TRUE,
           break.x.by=6,
           axes.offset=FALSE,
           #xlim=c(0,16),
           data = mRCdataFiber) 
print(pfs_rcc)
#rcc_plt <- ggsave_workaround(pfs_rcc)
#ggsave("svg/extended_figure_1_part_a_RCC_PFS.svg", plot =rcc_plt, w=8, h = 5)
```

## Panel B

Mortality Hazard for PFS by daily average fiber intake, visualized via partial smoothing spline for pateints with Urothelial Cancer.  Ticks along the x axis represent individual patients. 

```{r}
#| warning: false
#| include: true
#| label: panel_b


#Extended Data Figure 2
kmPFS<-survfit(Surv(pfs_mo, pod_status)~fiber_dichotomized,
               type="kaplan-meier", data=mUCdataFiber)

pfs_uc <- ggsurvplot(kmPFS,risk.table=TRUE,
           xlab="Time (months)", 
           ylab="Progression-free survival",
           pval = TRUE,
           legend="none",
           title="Patients with urothelial cancer on ICB",
           legend.title="Fiber intake",
           legend.labs=c("<15 g/day","15+ g/day"),
           #surv.median.line = "hv",
           conf.int=TRUE,
           break.x.by=6,
           axes.offset=FALSE,
           xlim=c(0,16),
           data = mUCdataFiber)
print(pfs_uc)
#uc_plt <- ggsave_workaround(pfs_uc)
#ggsave("svg/extended_figure_1_part_b_UC_PFS.svg", plot = uc_plt, w=8, h = 5)
```

## Panel C

Multivariate Model Progression Free Survival Sensitivity Analysis

```{r}
#| warning: false
#| include: true
#| label: panel_c
AllMetdataFiber <- mutate(AllMetdataFiber,  fiber_dichotomized_12 = case_when(aofib>=12~1,
                                                                              aofib<12~0))

AllMetdataFiber <- mutate(AllMetdataFiber,  fiber_dichotomized_14 = case_when(aofib>=14~1,
                                                                              aofib<14~0))

AllMetdataFiber <- mutate(AllMetdataFiber,  fiber_dichotomized_16 = case_when(aofib>=16~1,
                                                                              aofib<16~0))

AllMetdataFiber <- mutate(AllMetdataFiber,  fiber_dichotomized_18 = case_when(aofib>=18~1,
                                                                              aofib<18~0))

AllMetdataFiber <- mutate(AllMetdataFiber,  fiber_dichotomized_20 = case_when(aofib>=20~1,
                                                                              aofib<20~0))

AllMetdataFiber <- mutate(AllMetdataFiber,  fiber_dichotomized_22 = case_when(aofib>=22~1,
                                                                              aofib<22~0))

AllMetdataFiber <- mutate(AllMetdataFiber,  fiber_dichotomized_24 = case_when(aofib>=24~1,
                                                                              aofib<24~0))

AllMetdataFiber <- mutate(AllMetdataFiber,  fiber_dichotomized_26 = case_when(aofib>=26~1,
                                                                              aofib<26~0))

AllMetdataFiber <- mutate(AllMetdataFiber,  fiber_dichotomized_28 = case_when(aofib>=28~1,
                                                                              aofib<28~0))


###multivariable PFS

cox_pfs_12_uv <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized_12 +
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC + stage.simplified.factor,
                      AllMetdataFiber)
summary(cox_pfs_12_uv)

cox_pfs_14_uv <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized_14 +
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC + stage.simplified.factor,
                      AllMetdataFiber)
summary(cox_pfs_14_uv)

cox_pfs_15_uv <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized +
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC + stage.simplified.factor,
                      AllMetdataFiber)
summary(cox_pfs_15_uv)

cox_pfs_16_uv <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized_16 +
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC + stage.simplified.factor,
                      AllMetdataFiber)
summary(cox_pfs_16_uv)

cox_pfs_18_uv <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized_18 +
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC + stage.simplified.factor,
                      AllMetdataFiber)
summary(cox_pfs_18_uv)

cox_pfs_20_uv <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized_20 + 
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC + stage.simplified.factor,
                      AllMetdataFiber)
summary(cox_pfs_20_uv)

cox_pfs_22_uv <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized_22 +
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC + stage.simplified.factor,
                      AllMetdataFiber)
summary(cox_pfs_22_uv)

cox_pfs_24_uv <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized_24 +
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC + stage.simplified.factor,
                      AllMetdataFiber)
summary(cox_pfs_24_uv)

cox_pfs_26_uv <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized_26+
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC  + stage.simplified.factor,
                      AllMetdataFiber)
summary(cox_pfs_26_uv)

cox_pfs_28_uv <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized_28+
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC + stage.simplified.factor,
                      AllMetdataFiber)
summary(cox_pfs_28_uv)


#Calculating number of patients categorized as "high fiber" as a function of each dichotomization threshold
sum(AllMetdataFiber$fiber_dichotomized_12) #69
sum(AllMetdataFiber$fiber_dichotomized_14) #61
sum(AllMetdataFiber$fiber_dichotomized) #56
sum(AllMetdataFiber$fiber_dichotomized_16) #51
sum(AllMetdataFiber$fiber_dichotomized_18) #40
sum(AllMetdataFiber$fiber_dichotomized_20) #30
sum(AllMetdataFiber$fiber_dichotomized_22) #26
sum(AllMetdataFiber$fiber_dichotomized_24) #21
sum(AllMetdataFiber$fiber_dichotomized_26) #16
sum(AllMetdataFiber$fiber_dichotomized_28) #13

forestplot_data <- tibble::tibble(mean  = c(0.5372, 0.4573, 0.4561, 0.5931, 0.6348, 0.7771, 0.6661, 0.7746, 0.8386, 0.8371),
                                  lower = c(0.2786, 0.2534, 0.2560, 0.3422, 0.3649, 0.4328, 0.3583, 0.4031, 0.4010, 0.3637),
                                  upper = c(1.036, 0.8254, 0.8125,  1.028, 1.105, 1.395, 1.239, 1.489, 1.753, 1.927),
                                  study = c("12", "14", "15", "16", "18", "20", "21", "24", "26", "28"),
                                  HighFiber  = c("69","61","56","51","40","30","26","21","16","13"),
                                  HR = c("0.54", "0.46", "0.46", "0.59", "0.63", "0.78","0.67","0.77", "0.84", "0.84"))

forestplot_data |>
  forestplot(labeltext = c(study, HighFiber,HR),
             clip = c(0.09, 2.5),
             xlog = TRUE,
             xlab = "Hazard ratio for PFS (95% CI)",
             xticks = c(0.25,0.5,1.0,2.5),
             title = "Multivariable progression-free survival sensitivity analysis",
             boxsize = 0.5,
             align = c("c", "c", "r"),
             txt_gp = fpTxtGp(
               xlab = gpar(cex = 1.2),  # Increase size of the x-axis title (e.g., to 120%)
               ticks = gpar(cex = 1.1)  # Increase size of the x-axis tick labels (e.g., to 110%)
             )) |>
  fp_set_style(box = "royalblue",
               line = "darkblue",
               summary = "royalblue") |> 
  fp_add_header(study = c("Fiber threshold (g/day)"),
                HighFiber = c("High-fiber patients (n)"),
                #n = c("n"),
                #events = c("Events"),
                HR = c("HR"))


#dev.copy(svg, "svg/extended_figure_1_part_c_forest_plt.svg")
#dev.off()
```


## Panel D

Smoothing spline for PFS as a function of avg grams of daily fiber/avg daily kCal.  Each tick corresponds to a patient. 

```{r}
#| warning: false
#| include: true
#| label: panel_d

#gram_fiber_per_Kcal_aboveRecommended


multivariate_cox_fiber_per_kCal <-coxph(Surv(pfs_mo,pod_status)~ fiber_dichotomized +
                        ageby10 + ecog_1to5_final + cancer_RCCvsUC + kcalor,
                      AllMetdataFiber)

summary(multivariate_cox_fiber_per_kCal)

univariate_cox_fiber_per_kCal <-coxph(Surv(pfs_mo,pod_status)~ gram_fiber_per_Kcal_aboveRecommended,
                      AllMetdataFiber)

summary(univariate_cox_fiber_per_kCal)

univariate_cox_fiber_per_kCal <-coxph(Surv(pfs_mo,pod_status)~ aofib,
                      AllMetdataFiber)

summary(univariate_cox_fiber_per_kCal)

makeSpline(AllMetdataFiber, AllMetdataFiber$pfs_mo, AllMetdataFiber$pod_status, 
           AllMetdataFiber$gram_fiber_per_Kcal,
           xlab = "(Average daily grams of fiber)/(Average daily kilocalories)", ylab="Hazard ratio (95% CI)",
           title="Smoothing spline for progression-free survival",
           knots=3) +
  scale_x_continuous(breaks = c(5,10,15,20)) + 
 theme(
     axis.text = element_text(size = 18), # Adjust axis labels
     axis.title = element_text(size = 20), # Adjust axis titles
     plot.title = element_text(size = 24),  # Adjust plot title
     legend.text = element_text(size = 18),  # Adjust legend text
     legend.title = element_text(size = 20), # Adjust legend titleMetronidazole
     strip.text.x = element_text(size = 18),
     strip.text.y = element_text(size = 18) 
 ) 

ggsave("svg/extended_figure_1_part_d_spline.svg", w=8, h = 5)

```

